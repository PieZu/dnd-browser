<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    <title>DND Spell Browser</title>
    <style>
      .checkbox {
        background-color: #fff;
        border: solid 1px #d7d7d7;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
        height: 16px;
        margin-right: 4px;
        width: 16px;
        text-align: center;
        vertical-align: middle;

        svg {
          margin-top: 6px;
          stroke: #fff;
        }
      }
      .include {
        background-color: #4aca65;
        border-color: #43b45b;
      }

      .exclude {
        background-color: #dc4e4e;
        border-color: #c74545;
      }
      
      .ClassList {
        font-style: italic;
      }
      .Class {
        background-color: #eee;
        border: 1px;
        border-radius: 5px;
      }
      .Class:hover {
        background-color: #ccc;
      }
      
      input[type=number] {
        width: 25px;
      }
    </style>
  </head>
  
  <body>
    <div id="search">
      <label for="spellid">  ID:    </label> <input type="text" id="spellid">
      <button onclick="loadSpell()">Load</button>
      <br>
      <label for="spellname">Name:  </label> <input type="text" id="spellname">
      <label for="verbal">   V      </label> <span class="checkbox" id="verbal"></span>
      <label for="somatic">  S      </label> <span class="checkbox" id="somatic"></span>
      <label for="material"> M      </label> <span class="checkbox" id="material"></span>
      <label for="class">    Class: </label> <select id="class"><option value="">&lt;any&gt;</option></select>
      <label for="school">   School</label>  <select id="school"><option value="">&lt;any&gt;</option></select>
      <label for="maxlvl">Maximum Level<label> <input id="maxlvl" type="number" value="9" min="0" max="9">
      <button onclick="findSpell()">Search</button>
    </div>
      
    <div id="spell display">
    </div>
    
    <script>
      function loadSpell(id = document.getElementById("spellid").value) {
        fetch("/spell/"+id, {})
          .then(res => res.json())
          .then(spell => {
            document.getElementById("spell display").innerHTML = displaySpell(spell)
          });
        }
      
      function findSpell() {
        let body = {name:         document.getElementById("spellname").value, 
                    class:        document.getElementById("class").value,
                    school:       document.getElementById("school").value,
                    maximumlevel: document.getElementById("maxlvl").value}
        
        let comps = ["verbal", "somatic", "material"]
        comps.forEach(component=>{
          values = document.getElementById(component).classList
          if (values.contains("include")) body[component] = 1
          if (values.contains("exclude")) body[component] = 0
        })
        
        fetch("/spells/", {method: "post", headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)}) 
          .then(res => {console.log(res);return res.json()})
          .then(spells => {
            console.log(spells)
            document.getElementById("spell display").innerHTML =""
            spells.forEach(spell=>{document.getElementById("spell display").innerHTML += displaySpell(spell)})
          });
        }
      
        function displaySpell(spell) {
          console.log(spell)
          var school 
          switch (spell.level) {
            case 0:
              school = spell.school+" Cantrip"
              break
            case 1:
              school = "1st level "+spell.school
              break
            case 2:
              school = "2nd level "+spell.school
              break
            case 3:
              school = "3rd level "+spell.school
              break
            default:
              school = spell.level+"th level "+spell.school
          } 
          
          let components = []
          for (let i=0; i <3; i++) { if ([spell.verbal, spell.somatic, spell.material][i]) components.push("VSM"[i]) } // yes theres probably a way to do this more elegantly but hey this was has the string 'i <3' which is cute
          
          return `
            <h1 class="Name"> ${spell.spell_name} </h1>
            <em class="School"> <span onclick="set('school', '${spell.school}')">${school} </span>
            <br>Usable by: <span class="ClassList">
                ${spell.classes.split(", ").map(x=>`<span class="Class" onclick="set('class', '${x}')"; findSpell()">${x}</span>`).join(", ")}
            </span>
              
            <p>
              <br>Components: <strong>${components.join(", ")}</strong>
              ${components.includes("M")? "<br>Materials: <strong>"+spell.materials+"</strong>" :""}
              <br>Casting time: <strong>${spell.casttime}</strong>
              <br>Duration: <strong>${spell.duration}</strong>
              <br>Range: <strong>${spell.range}</strong>

              <br><br>
              ${spell.spell_description}
            </p>
            `
        }
      
      function set(property, value) { // helper function to make onclicks easier
        document.getElementById(property).value = value
        findSpell()
      }
      // make the tristate checkbox filter work
      [...document.getElementsByClassName("checkbox")].forEach(box=>{
        box.onclick = (e)=>{
          if (box.classList.contains("include")) {
            box.classList.remove("include")
            box.classList.add("exclude")
          } 
          else if (box.classList.contains("exclude")) {
            box.classList.remove("exclude")
          } 
          else {
            box.classList.add("include")
          }
        }
      })
      
      // populate class filter list
      function populateOptions(property) {
        fetch(property+"List").then(res=>res.json()).then(options=>{
          options.forEach(({name})=>{
            document.getElementById(property).innerHTML += "<option>"+name+"</option>"
          })
        })
      }
      populateOptions("class")
      populateOptions("school")
    </script>
  </body>
</html>